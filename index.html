<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatOgre Editor ðŸš§ Under Construction</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
</head>

<body>
    <div id="app">
        <div class="navbar-wrap">
            <div class="navbar-content">
                <div class="navbar-left">
                    <img src="./media/logo.svg" alt="Logo" draggable="false" class="navbar-logo">
                    <div class="line"></div>

                    <div class="navbar-dropdown" tabindex="0">
                        <div class="dropdown-head">File</div>
                        <div class="dropdown-items">
                            <button class="dropdown-item">New Project</button>
                            <hr>
                            <button class="dropdown-item">Save</button>
                            <button class="dropdown-item">Load</button>
                            <hr>
                            <button class="dropdown-item">Save As New</button>
                            <button class="dropdown-item">Rewind To Last Save</button>
                        </div>
                    </div>

                    <div class="navbar-dropdown" tabindex="0">
                        <div class="dropdown-head">Edit</div>
                        <div class="dropdown-items">
                            <button class="dropdown-item">Undo</button>
                            <button class="dropdown-item">Redo</button>
                            <hr>
                            <button class="dropdown-item">Enable Turbo Mode</button>
                            <button class="dropdown-item">Enable Full Screen</button>
                            <hr>
                            <button class="dropdown-item">Preferences</button>
                            <button class="dropdown-item">Help</button>
                        </div>
                    </div>

                    <div class="navbar-dropdown" tabindex="0">
                        <div class="dropdown-head">Info</div>
                        <div class="dropdown-items">
                            <button class="dropdown-item">Report Bug</button>
                            <button class="dropdown-item">Contribute on Github</button>
                            <hr>
                            <button class="dropdown-item">About CatOgre</button>
                            <button class="dropdown-item">Terms of Service</button>
                            <hr>
                            <button class="dropdown-item">Connect to Scratch</button>
                        </div>
                    </div>

                    <div class="line"></div>

                    <input type="text" class="navbar-name" id="projName" placeholder="Name Your Project" value="Untitled">
                </div>
                <div class="navbar-right">

                </div>
            </div>
        </div>

        <div class="main-space">
            <div class="workspace">
                <div class="code-edit">
                    <div id="code"></div>
                    <textarea id="input" spellcheck="false"></textarea>
                </div>
            </div>
            <div class="stage">
                <div class="stage-player">
                    <canvas width="400" height="300" id="stageCanvas"></canvas>
                </div>
                <div class="stage-sprites"></div>
            </div>
        </div>
    </div>
</body>

<script>

    //smooth dragging algorithm with rotation
    //item: the html item that would be draggable
    //easeFactor: how slow the item would be following the mouse. 1 for instant
    //rotFactor: how extreme the rotation will be. The more the number is the less extreme it'll be. 0 for no rotation

    function setItemDraggable(item, easeFactor, rotFactor){
        item.onmousedown = function(eDown){
            let mousePos = {
                x: eDown.pageX,
                y: eDown.pageY
            }

            let diffX = mousePos.x - item.offsetLeft;
            let diffY = mousePos.y - item.offsetTop;

            let itemTop = item.offsetTop;
            let itemLeft = item.offsetLeft;
            let itemDirection = 0;

            let targetX;
            let targetY;

            let interval = setInterval(function(){
                targetX = mousePos.x - diffX;
                targetY = mousePos.y - diffY;

                itemTop += (targetY - itemTop)/easeFactor;
                itemLeft += (targetX - itemLeft)/easeFactor;
                itemDirection = Math.atan((targetX - itemLeft)/rotFactor);
                if(rotFactor == 0) itemDirection = 0;

                item.style.top = `${itemTop}px`;
                item.style.left = `${itemLeft}px`;
                item.style.transform = `rotate(${itemDirection}rad)`
            }, 10);

            document.onmousemove = function(e){
                mousePos = {
                    x: e.pageX,
                    y: e.pageY
                }
            }

            document.onmouseup = function(){
                clearInterval(interval);
                item.style.transform = null;
                document.onmousemove = null;
                document.onmouseup = null;
            }

            item.ondragstart = function() {
                return false;
            };
        }
    }

    //Highlight Syntax

    const codeArea = document.querySelector("#code")
    const inputArea = document.querySelector("#input")

    const highlight = (str) => {
        let lines = str.split("\n")
        let events = /(whenFlagClicked|whenCloneStarts)/g
        let classes = /(sprite|input)/g
        let movement = /(goTo|turnCW|setX|setY|changeX|changeY)/g
        let looks = /(sayFor|say)/g
        let control = /(forever|if|createClone|wait|end|repeatUntil|else)/g
        let numbers = /(-)?\d+/g
        let symbols = /(\(|\)|;|{|})/g
        let sensing = /(keyPressed)/g
        let strings = /"(.*)"/g
        codeArea.innerHTML = ""
        lines.forEach(line => {
            line = line.replace(strings, "<span class=\"string\">$&</span>")
            line = line.replace(symbols, "<span class=\"symbol\">$&</span>")
            line = line.replace(numbers, "<span class=\"number\">$&</span>")
            line = line.replace(classes, "<span class=\"class\">$&</span>")
            line = line.replace(movement, "<span class=\"movement\">$&</span>")
            line = line.replace(looks, "<span class=\"looks\">$&</span>")
            line = line.replace(events, "<span class=\"event\">$&</span>")
            line = line.replace(control, "<span class=\"control\">$&</span>")
            line = line.replace(sensing, "<span class=\"sensing\">$&</span>")
            codeArea.innerHTML += `<div class="line">${line}</div>`
        })
    }

    window.addEventListener("load", () => {
        inputArea.addEventListener("input", () => {
            highlight(inputArea.value)
        })

        inputArea.addEventListener("scroll", () => {
            codeArea.scrollTop = inputArea.scrollTop
            codeArea.scrollLeft = inputArea.scrollLeft
        })
    })
</script>
</html>
